<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TGIF</title>
  <script src="https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.js"
    onerror="console.error('Failed to load GIF.js')"></script>
  <script>
    console.log("GIF.js loaded:", typeof GIF !== 'undefined');
    window.GIF = GIF;
  </script>
</head>

<body>
  <h1>TGIF</h1>
  <!-- Interval Input -->
  <label for="interval">Interval (ms):</label>
  <input type="number" id="interval" value="500" min="100" />

  <!-- Export Size Selection -->
  <label for="size">Export Size:</label>
  <select id="size">
    <option value="0.5">0.5x</option>
    <option value="1">1x</option>
    <option value="2">2x</option>
    <option value="3">3x</option>
  </select>

  <!-- Export Button -->
  <button id="export">Export GIF</button>
  <script>
    document.getElementById("export").onclick = () => {
      const interval = document.getElementById("interval").value;
      const scale = document.getElementById("size").value;

      parent.postMessage(
        {
          pluginMessage: {
            type: "export-gif",
            interval: parseInt(interval, 10),
            scale: scale
          }
        },
        "*"
      );
    };

    window.onmessage = (event) => {
      const message = event.data.pluginMessage;

      if (message.type === 'frames-exported') {
        const { images, interval } = message;

        // Generate GIF using gif.js
        const gif = new GIF({
          workers: 2,
          quality: 10,
        });

        images.forEach((imageData) => {
          const img = new Image();
          img.src = imageData;
          img.onload = () => {
            gif.addFrame(img, { delay: interval });
          };
        });

        gif.on('finished', (blob) => {
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = 'animation.gif';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        });

        gif.render();
      }
    };
  </script>
</body>

</html>